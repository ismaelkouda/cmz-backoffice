<div class="filter-container">
    <form [formGroup]="formGroup()" (ngSubmit)="onSubmitFilterForm()">
        <div class="filter-grid">
            @for (field of primaryFields(); track field.name) {
                <div class="filter-grid__item" [ngClass]="field.class || ''">
                    <ng-container *ngTemplateOutlet="fieldRenderer; context: { $implicit: field }"></ng-container>
                </div>
            }

            <div class="filter-grid__item d-flex align-items-end gap-2" style="flex-direction: row; min-width: auto;">
                 @if (!isExpanded() || secondaryFields().length === 0) {
                    <button
                        type="submit"
                        class="btn btn-primary px-3"
                        [disabled]="isLoading()"
                    >
                        <i class="pi pi-filter"></i>
                    </button>
                }

                @if (secondaryFields().length > 0) {
                     <button
                        type="button"
                        (click)="toggleExpanded()"
                        class="btn btn-dark px-3"
                    >
                        <i class="pi" [ngClass]="isExpanded() ? 'pi-minus' : 'pi-plus'"></i>
                    </button>
                }
            </div>
        </div>

        @if (isExpanded() && secondaryFields().length > 0) {
            <div class="filter-grid mt-3">
                @for (field of secondaryFields(); track field.name) {
                    <div class="filter-grid__item" [ngClass]="field.class || ''">
                         <ng-container *ngTemplateOutlet="fieldRenderer; context: { $implicit: field }"></ng-container>
                    </div>
                }

                <div class="filter-grid__item d-flex align-items-end" style="min-width: auto;">
                    <button
                        type="submit"
                        class="btn btn-primary px-3"
                        [disabled]="isLoading()"
                    >
                        <i class="pi pi-filter"></i>
                    </button>
                </div>
            </div>
        }
    </form>
</div>

<ng-template #fieldRenderer let-field>
    @switch (field.type) {
        @case ('text') {
            <imako-input
                [label]="field.label"
                [control]="getControl(field.name)"
                [placeholder]="field.placeholder || ''"
            ></imako-input>
        }
        @case ('select') {
            <imako-select
                [label]="field.label"
                [control]="getControl(field.name)"
                [options]="field.options || []"
                [placeholder]="field.placeholder || ''"
                [optionLabel]="field.optionLabel || 'label'"
                [optionValue]="field.optionValue || 'value'"
                [showClear]="field.showClear !== false"
                [loading]="field.loading || false"
                [styleClass]="field.class || ''"
                [filter]="field.filter !== false"
            ></imako-select>
        }
        @case ('multi-select') {
            <imako-multi-select
                [label]="field.label"
                [control]="getControl(field.name)"
                [options]="field.options || []"
                [placeholder]="field.placeholder || ''"
                [optionLabel]="field.optionLabel || 'label'"
                [optionValue]="field.optionValue || 'value'"
                [loading]="field.loading || false"
                [showToggleAll]="field.showToggleAll !== false"
                [showClear]="field.showClear !== false"
                [filter]="field.filter !== false"
                [styleClass]="field.class || ''"
            ></imako-multi-select>
        }
        @case ('date') {
            <imako-date
                [label]="field.label"
                [control]="getControl(field.name)"
                [placeholder]="field.placeholder || ''"
                [styleClass]="field.class || ''"
            ></imako-date>
        }
        @case ('template') {
            <ng-container *ngTemplateOutlet="field.template || null"></ng-container>
        }
    }
</ng-template>
