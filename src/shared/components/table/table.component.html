<p-table
    #dt
    [value]="items()"
    [rowHover]="true"
    [rows]="pagination()?.per_page || 10"
    [globalFilterFields]="config().globalFilterFields"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="430px"
    role="grid"
    width="100%"
    [columns]="config().cols"
    styleClass="p-datatable-gridlines"
    [reorderableColumns]="true"
    selectionMode="single"
    [dataKey]="dataKey()"
    [tableStyle]="{ 'min-width': '75rem' }"
>
    <ng-template pTemplate="caption">
        <div class="container-table-header">
            <app-table-title
                [count]="pagination()?.total"
                [perPage]="pagination()?.per_page"
                [page]="pagination()?.current_page"
                [totalPage]="pagination()?.last_page"
            >
            </app-table-title>
            <div class="d-flex gap-2 align-items-center custom-header-actions mt-2 mt-md-0">
                <app-table-button-header
                    (export)="onExportExcel()"
                    (refresh)="onRefresh()"
                    (other)="onCreate()"
                    [disabledButtonExport]="loading() || items().length === 0"
                    [disabledButtonRefresh]="loading()"
                    [hiddenButtonOther]="hiddenButtonOther()"
                >
                </app-table-button-header>
                <app-search-table [dt]="dt" />
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="header" let-columns>
        <tr>
            @for (col of columns; track trackByColField($index, col)) {
                <th
                    [class]="col.class"
                    [style.width]="col.width"
                    [pSortableColumn]="col.field"
                >
                    @if (col.field !== '__action' && col.field !== '__reorder' && col.field !== '__index') {
                        {{ col.header | translate }}
                        <p-sortIcon
                            [field]="col.field"
                            *ngIf="col.field !== '__action' && col.field !== '__reorder'"
                        ></p-sortIcon>
                    } @else {
                        {{ col.header | translate }}
                    }
                </th>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-rowData let-columns="columns" let-rowIndex="rowIndex">
        <tr role="row" [class.cursor-pointer]="!loading()" [pReorderableRow]="rowIndex">
            @for (col of columns; track trackByColField($index, col)) {
                <td [class]="col.class">
                    @if (col.type === 'badge-button') {
                        @if (rowData[col.field]) {
                            <div class="flex justify-content-center">
                                <p-button
                                    [badge]="rowData[col.field]"
                                    (onClick)="onBadgeClick(rowData, col)"
                                    severity="contrast"
                                    size="small"
                                    [label]="'Visualiser'"
                                />

                            </div>
                        } @else {
                            <ng-template #noOperators>
                                <span class="no-data">-</span>
                            </ng-template>
                        }
                    } @else if (col.type === 'number') {
                        {{ rowData[col.field] | separatorThousandsPipe }}
                    } @else {
                        @switch (col.field) {
                            @case ('__reorder') {
                                <span
                                    class="pi pi-bars"
                                    pReorderableRowHandle
                                ></span>
                            }
                            @case ('__index') {
                                {{
                                    ((pagination()?.current_page - 1 || 0) *
                                        (pagination()?.per_page || 0) +
                                        rowIndex +
                                        1)
                                }}
                            }

                            @case ('status') {
                                <p-tag
                                    [value]="rowData.status | translate"
                                    [severity]="'success'"
                                />
                            }
                            @case ('createdAt') {
                                {{ formatDate(rowData.createdAt) }}
                            }
                            @case ('updatedAt') {
                                {{ formatDate(rowData.updatedAt) }}
                            }
                            @case ('uniqId') {
                                <p-tag
                                    value="{{ rowData.uniqId }}"
                                    severity="secondary"
                                    class="cursor-pointer"
                                    (click)="copyToClipboard(rowData.uniqId)"
                                    pTooltip="{{ 'COPY' | translate }}"
                                    tooltipPosition="bottom"
                                />
                            }
                            @case ('reportType') {
                                <div>
                                    {{ rowData.reportType | translate }}
                                </div>
                            }
                            @case ('operators') {
                                <div class="tag-group" *ngIf="rowData.operators?.length; else noOperators">
                                    @for (operator of rowData.operators; track $index) {
                                        <p-tag
                                            [value]="operator | translate"
                                            [style]="getOperatorTagStyle(operator | translate)"
                                            styleClass="operator-tag"
                                        />
                                    }
                                </div>
                                <ng-template #noOperators>
                                    <span class="no-data">-</span>
                                </ng-template>
                            }
                            @case ('reportedAt') {
                                <time [attr.datetime]="rowData.reportedAt">
                                    {{ formatDate(rowData.reportedAt) }}
                                </time>
                            }
                            @case ('source') {
                                <div class="source-type-content">
                                    <span>{{ rowData.source | translate }}</span>&nbsp;
                                    <span
                                        class="copyable"
                                        pTooltip="{{ 'COPY' | translate }}"
                                        (click)="copyToClipboard(rowData.initiatorPhoneNumber)"
                                        tooltipPosition="bottom"
                                    >[ {{ rowData.initiatorPhoneNumber }} ]
                                    </span>
                                </div>
                            }
                            @case ('__action') {
                                <div (onKeyPress)="$event.stopPropagation()" class="action-group">
                                    <button
                                        type="button"
                                        pButton
                                        icon="pi pi-window-maximize"
                                        (click)="onActionClick(rowData)"
                                        pTooltip="{{ 'REPORTS_REQUESTS.QUEUES.TABLE.TAKE' | translate }} {{ rowData.uniqId }}"
                                        tooltipPosition="bottom"
                                        [disabled]="loading()"
                                        size="small"
                                        class="action-btn"
                                    ></button>
                                </div>
                            }
                            @case ('__actionDropdown') {
                                <app-home-action-dropdown
                                    [disabled]="loading()"
                                    [status]="getItemStatus(rowData)"
                                    (edit)="onEdit(rowData)"
                                    (view)="onView(rowData)"
                                    (delete)="onDelete(rowData)"
                                ></app-home-action-dropdown>
                            }
                            @default {
                                {{ rowData[col.field] }}
                            }
                        }
                    }
                </td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage" let-columns>
        <tr role="row">
            <td [attr.colspan]="columns.length" class="text-center">
                @if (!loading()) {
                    {{ 'COMMON.NO_DATA' | translate }}
                } @else {
                    <p-progressSpinner
                        [style]="{ width: '30px', height: '50px' }"
                        strokeWidth="8"
                        fill="#EEEEEE"
                        animationDuration=".5s"
                    ></p-progressSpinner>
                }
            </td>
        </tr>
    </ng-template>
</p-table>