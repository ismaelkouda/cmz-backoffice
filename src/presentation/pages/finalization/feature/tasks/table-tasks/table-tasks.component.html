<p-table
    #dt
    [value]="tasks()"
    [rowHover]="true"
    [rows]="(pagination$ | async)?.per_page"
    [globalFilterFields]="tableConfig.globalFilterFields"
    responsiveLayout="scroll"
    scrollable="true"
    scrollHeight="flex"
    data-testid="tasks-table"
    role="grid"
    selectionMode="multiple"
    datakey="id"
>
    <ng-template pTemplate="caption">
        <div class="flex justify-between items-center flex-wrap gap-3">
            <app-table-title
                [count]="(pagination$ | async)?.total"
                [perPage]="(pagination$ | async)?.per_page"
                [page]="(pagination$ | async)?.current_page"
                [totalPage]="(pagination$ | async)?.last_page"
            />
            
            <div class="flex gap-2 items-center custom-header-actions mt-2 mt-md-0">
                <app-table-button-header
                    (export)="onExportExcel()"
                    (refresh)="onRefresh()"
                    [disabledButtonExport]="isLoading() || !hasData()"
                    [disabledButtonRefresh]="isLoading()"
                    [hiddenButtonOther]="true"
                />
                <app-search-table [dt]="dt" />
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr role="row">
            @for (col of tableConfig.cols; track trackByColField($index, col)) {
            <th
                [class]="col.class"
                [style]="{
                    'min-width': col.width,
                    'width': col.width,
                    'text-align': 'center'
                }"
                role="columnheader"
                scope="col"
            >
                @switch (col.field) {
                    @case ('__selection') {
                        <div class="selection-header">
                            <p-inputNumber
                    [showButtons]="false"
                    [placeholder]="'Select count...'"
                    [min]="0"
                    [max]="tasks().length"
                    inputMode="numeric"
                    [ngModel]="selectionInputValue()"
                    (ngModelChange)="handleSelectCount($event)"
                    (keydown.enter)="$event.target.blur()"
                    (keydown.escape)="clearSelection()"
                    [disabled]="!hasData() || isLoading()"
                />
                        </div>
                    }
                    @default {
                        {{ col.header | translate }}
                    }
                }
            </th>
            }
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-task let-rowIndex="rowIndex">
        <tr 
            role="row"
            [class.selected]="isItemSelected(task)"
            [attr.aria-selected]="isItemSelected(task)"
            (click)="handleRowClick($event, task)"
            [class.cursor-pointer]="!isLoading()"
        >
            @for (col of tableConfig.cols; track trackByColField($index, col)) {
            <td
                [class]="col.class"
                [style]="{
                    'min-width': col.width,
                    'width': col.width
                }"
                role="gridcell"
            >
                @switch (col.field) {
                    @case ('__selection') {
                        <p-checkbox
                            [binary]="true"
                            [ngModel]="isItemSelected(task)"
                            (onChange)="handleItemSelection(task)"
                            [inputId]="'select-' + task.uniqId"
                            [name]="'select-' + task.uniqId"
                            [ariaLabelledBy]="'select-' + task.uniqId"
                            [disabled]="isLoading()"
                            data-testid="item-checkbox-{{task.uniqId}}"
                        />
                    }
                    
                    @case ('uniqId') {
                        <button
                            type="button"
                            (click)="copyToClipboard(task.uniqId)"
                            class="copy-button"
                            pTooltip="{{ 'COPY' | translate }}"
                        >
                            <span class="id-text">{{ task.uniqId }}</span>
                            <i class="pi pi-copy" aria-hidden="true"></i>
                        </button>
                    }

                    @case ('reportType') {
                        {{ getReportTypeLabel(task.reportType) }}
                    }

                    @case ('operators') {
                        <div class="tag-group" *ngIf="task.operators?.length; else noOperators">
                            @for (operator of task.operators; track trackByOperator($index, operator)) {
                                <p-tag
                                    [value]="getOperatorLabel(operator)"
                                    [style]="getOperatorTagStyle(operator)"
                                    styleClass="operator-tag"
                                />
                            }
                        </div>
                        <ng-template #noOperators>
                            <span class="no-data">-</span>
                        </ng-template>
                    }
                    
                    @case ('state') {
                        @if (task.state) {
                            <p-tag
                                [value]="getStateLabel(task.state)"
                                [severity]="getStateSeverity(task.state)"
                            />
                        } @else {
                            <span class="no-data">-</span>
                        }
                    }

                    @case ('createdAt') {
                        <time [attr.datetime]="task.createdAt">
                            {{ formatDate(task.createdAt) }}
                        </time>
                    }
                    
                    @case ('__action') {
                        <div (click)="$event.stopPropagation()" class="action-group">
                            <button
                                type="button"
                                pButton
                                icon="pi pi-window-maximize"
                                (click)="onActionClicked(task)"
                                [pTooltip]="getTakeTooltip(task)"
                                [disabled]="isLoading()"
                                size="small"
                                class="action-btn"
                            ></button>
                            <button
                                type="button"
                                pButton
                                icon="pi pi-book"
                                (click)="onJournalClicked(task)"
                                [pTooltip]="getJournalTooltip(task)"
                                [disabled]="isLoading()"
                                size="small"
                                class="action-btn"
                            ></button>
                        </div>
                    }
                    
                    @default {
                        {{ task[col.field] || '-' }}
                    }
                }
            </td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        @if (!isLoading()) {
            <tr role="row">
                <td [attr.colspan]="tableConfig.cols.length" role="gridcell">
                    <div class="empty-state">
                        {{ 'NO_DATA_FOUND' | translate }}
                    </div>
                </td>
            </tr>
        }
        @if (isLoading()) {
            <tr role="row">
                <td [attr.colspan]="tableConfig.cols.length" role="gridcell">
                    <div class="loading-state">
                        <p-progressSpinner
                            aria-label="Chargement des donnÃ©es"
                            strokeWidth="4"
                            styleClass="loading-spinner"
                        />
                    </div>
                </td>
            </tr>
        }
    </ng-template>
</p-table>
