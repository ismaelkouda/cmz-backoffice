<p-table
    [ngClass]="['native_table table']"
    [value]="listCartesSim"
    dataKey="id"
    selectionMode="single"
    [(selection)]="selectedTableCarteSim"
>
    <ng-template pTemplate="header">
        <tr>
            <th class="text-center">#</th>
            <th>{{ firstLevelLibelle }}</th>
            <th>{{ secondLevelLibelle }}</th>
            <th class="text-center">APN</th>
            <th class="text-center">Adresse IP</th>
            <th class="text-center">{{ thirdLevelLibelle }}</th>
            <th class="text-center">Emplacement</th>
            <th class="text-center">MSISDN</th>
            <th class="text-center">IMSI</th>
            <th>Statut</th>
            <th class="text-center" [style]="{ width: '3rem' }">Actions</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowIndex="rowIndex" let-data>
        <tr [pSelectableRow]="data">
            <td class="text-center">{{ rowIndex + pargination?.offset }}</td>
            <td>{{ data?.niveau_uns_nom }}</td>
            <td>{{ data?.niveau_deux_nom }}</td>
            <td class="text-center">{{ data?.apn }}</td>
            <td>{{ data?.adresse_ip }}</td>
            <td>{{ data?.niveau_trois_nom }}</td>
            <td>{{ data?.point_emplacement }}</td>
            <td (click)="copyData(data, 'msisdn')" class="px-2 cursor-pointer">
                {{ data.msisdn }}
            </td>
            <td (click)="copyData(data, 'imsi')" class="px-2 cursor-pointer">
                {{ data?.imsi ? data?.imsi : 'N/A' }}
            </td>
            <td class="text-center">
                <span
                    [ngStyle]="{ 'font-size': '16px' }"
                    class="badge"
                    [class.badge-success]="data.statut === 'actif'"
                    [class.badge-dark]="data.statut === 'suspendu'"
                    [class.badge-danger]="data.statut === 'resilié'"
                >
                    {{ data.statut }}
                </span>
            </td>
            <td class="td-actions">
                <button
                    pButton
                    icon="pi pi-map-marker"
                    class="p-button-success"
                    [disabled]="
                        data.statut === 'inactif' ||
                        (!data?.latitude &&
                            !data?.longitude &&
                            !data?.site_reseau)
                    "
                    pTooltip="Localisation"
                    tooltipPosition="top"
                    (click)="onShowDialog('map', data)"
                ></button>
                <button
                    pButton
                    icon="pi pi-qrcode"
                    [pTooltip]="data.qrcode ? 'Scaner' : ''"
                    tooltipPosition="top"
                    (click)="OnShowQr(data)"
                    [class]="
                        data.qrcode
                            ? 'p-button-help'
                            : 'p-button-help p-button-outlined'
                    "
                ></button>
                <button
                    pButton
                    pRipple
                    icon="pi pi-eye"
                    class="p-button-dark"
                    pTooltip="Voir"
                    tooltipPosition="top"
                    (click)="onShowForm(data, 'details')"
                ></button>
                <div ngbDropdown>
                    <button
                        type="button"
                        class="btn btn-dark btn-sm"
                        ngbDropdownToggle
                    >
                        Choisir
                    </button>
                    <div ngbDropdownMenu>
                        <button
                            ngbDropdownItem
                            (click)="onShowForm(data, 'editer')"
                        >
                            Modifier
                        </button>
                        <button
                            ngbDropdownItem
                            (click)="onTransactionForm(data, swap)"
                            *ngIf="
                                applicationType === patrimoineType &&
                                data.statut === 'actif'
                            "
                        >
                            SIM Swap
                        </button>
                        <button
                            ngbDropdownItem
                            (click)="onTransactionForm(data, resiliation)"
                            *ngIf="data.statut === 'suspendu'"
                        >
                            Résilier
                        </button>
                        <button
                            ngbDropdownItem
                            (click)="onTransactionForm(data, activation)"
                            *ngIf="data.statut === 'suspendu'"
                        >
                            Réactiver
                        </button>
                        <button
                            ngbDropdownItem
                            (click)="onTransactionForm(data, suspension)"
                            *ngIf="data.statut === 'actif'"
                        >
                            Suspendre
                        </button>
                        <button
                            ngbDropdownItem
                            (click)="onTransactionForm(data, formule)"
                            *ngIf="data.statut === 'actif'"
                        >
                            Changer la formule
                        </button>
                        <button
                            ngbDropdownItem
                            (click)="onTransactionForm(data, volume)"
                            *ngIf="
                                applicationType === patrimoineType &&
                                data.statut === 'actif'
                            "
                        >
                            Volume Data
                        </button>
                        <button
                            ngbDropdownItem
                            (click)="onDotationForm(data)"
                            *ngIf="
                                applicationType === patrimoineType &&
                                data.statut === 'actif'
                            "
                        >
                            Dotation
                        </button>
                    </div>
                </div>
            </td>
        </tr>
    </ng-template>
    <app-spinner
        [spinnerTable]="spinner"
        [listItems]="listCartesSim"
    ></app-spinner>
</p-table>

<p-dialog
    header="Vue géographique"
    [(visible)]="display"
    position="bottom-right"
    (onHide)="hideDialog('map')"
    [style]="{ width: '100%' }"
    (onMaximize)="onDialogMaximized($event)"
    [modal]="true"
    [responsive]="true"
    [maximizable]="true"
    [draggable]="false"
    [resizable]="false"
>
    <ng-template pTemplate="content" class="mt-4">
        <div class="mt-4">
            <div #parcelleMap></div>
        </div>
    </ng-template>
</p-dialog>

<ng-template #content let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">
            {{
                currentData?.type === 'suspendu' ? 'suspension' : 'resiliation'
            }}
            de la carte SIM
        </h4>
        <button
            type="button"
            class="btn-close"
            aria-label="Close"
            (click)="hideForm()"
        ></button>
    </div>
    <div class="modal-body" novalidate>
        <div class="form-group">
            <label>
                <b>MSNDN</b>
            </label>
            <input
                type="text"
                [ngStyle]="{ width: '100%' }"
                [placeholder]="currentData?.imsi"
                [disabled]="true"
                pInputText
            />
        </div>
        <br />
        <div class="form-group">
            <label>
                <b>Description</b>
            </label>
            <textarea
                class="form-control"
                [(ngModel)]="selectedDescription"
                rows="2"
            ></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <div>
            <button type="button" class="btn btn-hide" (click)="hideForm()">
                Fermer
            </button>
        </div>
        <div>
            <button
                type="button"
                class="btn btn-save"
                [disabled]="!selectedDescription"
                (click)="OnChangeStatut()"
            >
                Valider
            </button>
        </div>
    </div>
</ng-template>
