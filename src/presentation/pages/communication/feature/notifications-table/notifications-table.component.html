<p-table
    #dt
    [value]="notifications()"
    [rowHover]="true"
    [rows]="(pagination$ | async)?.per_page"
    [globalFilterFields]="tableConfig.globalFilterFields"
    responsiveLayout="scroll"
    scrollable="true"
    scrollHeight="flex"
    data-testid="notifications-table"
    role="grid"
    width="100%"
    [columns]="tableConfig.cols"
    [loading]="isLoading()"
    styleClass="p-datatable-gridlines"
    [tableStyle]="{ 'min-width': '75rem' }"
    selectionMode="multiple"
    datakey="id"
>
    <ng-template pTemplate="caption">
        <div class="container-table-header">
            <app-table-title
                [count]="(pagination$ | async)?.total"
                [perPage]="(pagination$ | async)?.per_page"
                [page]="(pagination$ | async)?.current_page"
                [totalPage]="(pagination$ | async)?.last_page"
            />

            <div
                class="d-flex gap-2 align-items-center custom-header-actions mt-2 mt-md-0"
            >
                <app-table-button-header
                    (export)="onExportExcel()"
                    (refresh)="onRefresh()"
                    [disabledButtonExport]="isLoading() || !hasData()"
                    [disabledButtonRefresh]="isLoading()"
                    [disabledButtonOther]="isLoading() || !hasData()"
                    [hiddenButtonOther]="false"
                    [labelOther]="'COMMUNICATION.NOTIFICATIONS.BUTTONS.DELETE'"
                />
                <app-search-table [dt]="dt" />
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="header" let-columns>
        <tr role="row">
            @for (col of columns; track trackByColField($index, col)) {
                <th
                    [class]="col.class"
                    [style.width]="col.width"
                    [pSortableColumn]="col.field"
                >
                    @switch (col.field) {
                        @case ('__selection') {
                            <div class="selection-header">
                                <p-inputNumber
                                    [showButtons]="false"
                                    [placeholder]="'Select count...'"
                                    [min]="0"
                                    [max]="notifications().length"
                                    inputMode="numeric"
                                    [ngModel]="selectionInputValue()"
                                    (ngModelChange)="handleSelectCount($event)"
                                    (keydown.enter)="$event.target.blur()"
                                    (keydown.escape)="clearSelection()"
                                    [disabled]="!hasData() || isLoading()"
                                />
                            </div>
                        }
                        @default {
                            {{ col.header | translate }}
                        }
                    }
                </th>
            }
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowData let-columns="columns" let-rowIndex="rowIndex">
        <tr role="row" [class.cursor-pointer]="!isLoading()">
            @for (col of columns; track trackByColField($index, col)) {
                <td [class]="col.class">
                    @switch (col.field) {
                        @case ('__selection') {
                            <p-checkbox
                                [binary]="true"
                                [ngModel]="isItemSelected(rowData)"
                                (onChange)="handleItemSelection(rowData)"
                                [inputId]="'select-' + rowData.uniqId"
                                [name]="'select-' + rowData.uniqId"
                                [ariaLabelledBy]="
                                    'select-' + rowData.uniqId
                                "
                                [disabled]="isLoading()"
                                data-testid="item-checkbox-{{
                                    rowData.uniqId
                                }}"
                            />
                        }

                        @case ('uniqId') {
                            <button
                                type="button"
                                (click)="copyToClipboard(rowData.uniqId)"
                                class="copyable"
                                pTooltip="{{ 'COPY' | translate }}"
                                tooltipPosition="bottom"
                            >
                                <span class="id-text">{{
                                    rowData.uniqId
                                }}</span>
                                <i class="pi pi-copy" aria-hidden="true"></i>
                            </button>
                        }

                        @case ('reportType') {
                            <div
                                [pTooltip]="
                                    rowData.reportDescription | translate
                                "
                                tooltipPosition="bottom"
                                showDelay="500"
                                hideDelay="300"
                            >
                                {{ rowData.reportType }}
                            </div>
                        }

                        @case ('operators') {
                            <div
                                class="tag-group"
                                *ngIf="
                                    rowData.operators?.length;
                                    else noOperators
                                "
                            >
                                @for (
                                    operator of rowData.operators;
                                    track trackByOperator($index, operator)
                                ) {
                                    <p-tag
                                        [value]="getOperatorLabel(operator)"
                                        [style]="getOperatorTagStyle(operator)"
                                        styleClass="operator-tag"
                                    />
                                }
                            </div>
                            <ng-template #noOperators>
                                <span class="no-data">-</span>
                            </ng-template>
                        }

                        @case ('createdAt') {
                            <time [attr.datetime]="rowData.createdAt">
                                {{ formatDate(rowData.createdAt) }}
                            </time>
                        }

                        @case ('source') {
                            <div
                                [pTooltip]="
                                    rowData.sourceDescription | translate
                                "
                                tooltipPosition="bottom"
                                showDelay="500"
                                hideDelay="300"
                                [tooltipStyleClass]="'custom-tooltip'"
                                class="source-type-content"
                            >
                                {{ rowData.source }}
                            </div>
                        }

                        @case ('__action') {
                            <div
                                (onKeyPress)="$event.stopPropagation()"
                                class="action-group"
                            >
                                <button
                                    type="button"
                                    pButton
                                    icon="pi pi-window-maximize"
                                    (click)="onActionClicked(rowData)"
                                    [pTooltip]="getSeeMoreTooltip(rowData)"
                                    tooltipPosition="bottom"
                                    [disabled]="isLoading()"
                                    size="small"
                                    class="action-btn"
                                ></button>
                            </div>
                        }

                        @default {
                            {{ rowData[col.field] || '-' }}
                        }
                    }
                </td>
            }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage" let-columns>
        <tr>
            @if (!isLoading()) {
                <td [attr.colspan]="columns.length" class="text-center">
                    {{ 'COMMON.NO_DATA' | translate }}
                </td>
            } @else {
                @for (col of columns; track trackByColField($index, col)) {
                    <td><p-skeleton /></td>
                }
            }
        </tr>
    </ng-template>
</p-table>
