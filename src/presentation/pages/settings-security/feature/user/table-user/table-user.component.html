<p-table
    #dt
    [value]="users()"
    [rowHover]="true"
    [rows]="(pagination$ | async)?.per_page"
    [globalFilterFields]="tableConfig.globalFilterFields"
    responsiveLayout="scroll"
    [scrollable]="true"
    scrollHeight="430px"
    data-testid="all-table"
    role="grid"
    width="100%"
>
    <ng-template pTemplate="caption">
        <div class="container-table-header">
            <app-table-title
                [count]="(pagination$ | async)?.total"
                [perPage]="(pagination$ | async)?.per_page"
                [page]="(pagination$ | async)?.current_page"
                [totalPage]="(pagination$ | async)?.last_page"
            >
            </app-table-title>
            <div
                class="d-flex gap-2 align-items-center custom-header-actions mt-2 mt-md-0"
            >
                <app-table-button-header
                    (export)="onExportExcel()"
                    (refresh)="onRefresh()"
                    [disabledButtonExport]="isLoading() || !hasData()"
                    [disabledButtonRefresh]="isLoading()"
                    [hiddenButtonOther]="false"
                    [labelOther]="'SETTINGS_SECURITY.USER.BUTTONS.ADD'"
                    (other)="onAddUser()"
                >
                </app-table-button-header>
                <app-search-table [dt]="dt" />
            </div>
        </div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr role="row">
            @for (col of tableConfig.cols; track trackByColField($index, col)) {
                <th
                    [class]="col.class"
                    [style]="{
                        'min-width': col.width,
                        width: col.width,
                        'text-align': 'center',
                    }"
                    role="columnheader"
                    scope="col"
                >
                    {{ col.header | translate }}
                </th>
            }
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowIndex="rowIndex" let-item>
        <tr role="row" [class.cursor-pointer]="!isLoading()">
             @for (col of tableConfig.cols; track trackByColField($index, col)) {
            <td
                    [class]="col.class"
                    [style]="{
                        'min-width': col.width,
                        width: col.width,
                    }"
                    role="gridcell"
            >
                @switch (col.field) {
                        @case ('__index') {
                            {{
                                ((pagination$ | async)?.current_page - 1 || 0) *
                                    ((pagination$ | async)?.per_page || 0) +
                                    rowIndex +
                                    1
                            }}
                        }
                        @case ('matricule') {
                            <button
                                type="button"
                                (click)="copyToClipboard(item.matricule)"
                                class="copyable"
                                pTooltip="{{ 'COPY' | translate }}"
                                tooltipPosition="bottom"
                            >
                                <span class="id-text">{{ item.matricule }}</span>
                                <!-- <i class="pi pi-copy" aria-hidden="true"></i> -->
                            </button>
                        }
                        @case ('profile') {
                            <p-tag
                                [value]="getProfileLabel(item.profile)"
                                [severity]="item.profile ? 'info' : 'warning'"
                            class="profil-tag"
                        ></p-tag>
                        }
                        @case ('fullName') {
                            {{ item.fullName }}
                        }
                        @case ('status') {
                            <div class="tag-group" [class]="col.class">
                                <p-tag
                                    [value]="item.status"
                                    [severity]="getStatusSeverity(item.status)"
                                    class="state-tag"
                                ></p-tag>
                            </div>
                        }
                        @case ('createdAt') {
                            <time [attr.datetime]="item.createdAt">
                                {{ formatDate(item.createdAt) }}
                            </time>
                        }
                        @case ('__action') {
                            <div class="dropdown">
                            <button
                                class="btn btn-sm btn-secondary dropdown-toggle"
                                type="button"
                                id="actionDropdown{{ rowIndex }}"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                [attr.aria-label]="
                                    'SETTINGS_SECURITY.USER.TABLE.ACTION'
                                        | translate
                                "
                            >
                                {{
                                    'SETTINGS_SECURITY.USER.TABLE.ACTION'
                                        | translate
                                }}
                            </button>
                            <ul
                                class="dropdown-menu"
                                [attr.aria-labelledby]="
                                    'actionDropdown' + rowIndex
                                "
                            >
                                <li>
                                    <a
                                        class="dropdown-item"
                                        (click)="
                                            onActionClicked(item, 'view');
                                            $event.preventDefault()
                                        "
                                        href="#"
                                    >
                                        {{
                                            'SETTINGS_SECURITY.USER.ACTIONS.VIEW'
                                                | translate
                                        }}
                                    </a>
                                </li>
                                <li>
                                    <a
                                        class="dropdown-item"
                                        (click)="
                                            onActionClicked(item, 'edit');
                                            $event.preventDefault()
                                        "
                                        href="#"
                                    >
                                        {{
                                            'SETTINGS_SECURITY.USER.ACTIONS.EDIT'
                                                | translate
                                        }}
                                    </a>
                                </li>
                                <li>
                                    <a
                                        class="dropdown-item text-danger"
                                        (click)="
                                            onActionClicked(item, 'disable');
                                            $event.preventDefault()
                                        "
                                        href="#"
                                    >
                                        {{
                                            'SETTINGS_SECURITY.USER.ACTIONS.DISABLE'
                                                | translate
                                        }}
                                    </a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider" />
                                </li>
                                <li>
                                    <a
                                        class="dropdown-item text-danger"
                                        (click)="
                                            onActionClicked(item, 'delete');
                                            $event.preventDefault()
                                        "
                                        href="#"
                                    >
                                        {{
                                            'SETTINGS_SECURITY.USER.ACTIONS.DELETE'
                                                | translate
                                        }}
                                    </a>
                                </li>
                            </ul>
                        </div>
                        }
                        @default {
                            {{ item[col.field] }}
                        }
                    }
            </td>
             }
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        @if (!isLoading()) {
            <tr role="row" class="loading-table">
                <td [attr.colspan]="tableConfig.cols.length" role="gridcell">
                    <div class="empty-state text-center">
                        {{ 'NO_DATA_FOUND' | translate }}
                    </div>
                </td>
            </tr>
        }
        @if (isLoading()) {
            <tr role="row" class="loading-table">
                <td [attr.colspan]="tableConfig.cols.length">
                    <p-progressSpinner
                        class="posCenter"
                        [style]="{ width: '40px', height: '50px' }"
                        styleClass="custom-spinner"
                        strokeWidth="8"
                        fill="#EEEEEE"
                        animationDuration=".5s"
                    >
                    </p-progressSpinner>
                </td>
            </tr>
        }
    </ng-template>
</p-table>
