<div class="container-fluid" [ngStyle]="{ 'margin-top': '1%' }">
  <app-breadcrumb [title]="'Suivi des opérations'" [active_item]="'Suivie & Traitement'"></app-breadcrumb>
  <div class="card" [ngStyle]="{ 'border-radius': '15px' }">
    <div class="card-body">
      <div class="row filter_wrapper">
        <div class="col-md-2">
          <div class="form-group">
            <label><b>Type opération <span class="text-danger">*</span></b></label>
            <p-dropdown [options]="listOperations" optionLabel="libele" [filter]="true" filterBy="nom,code"
              [showClear]="true" [(ngModel)]="selectedTypeOperation" placeholder="Selectionner Opération">
              <ng-template let-data pTemplate="item">
                <div class="country-item">
                  <div>{{ data.libele }}</div>
                </div>
              </ng-template>
            </p-dropdown>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label><b>Direction Régionale <span class="text-danger" *ngIf="!selectedOperationSYN">*</span></b></label>
            <p-dropdown [options]="listDirectionsRegionales" optionLabel="code" [filter]="true" filterBy="nom,code"
              [showClear]="true" (onChange)="onChangeItem($event.value, 'direction')" placeholder="Direction Régionale"
              name="dr" [ngClass]="{'desactiver': selectedOperationSYN}">
              <ng-template let-dr pTemplate="item">
                <div class="country-item">
                  <div>{{ dr.code }}</div>
                </div>
              </ng-template>
            </p-dropdown>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label><b>Exploitation <span class="text-danger" *ngIf="!selectedOperationSYN">*</span></b></label>
            <p-dropdown [options]="listExploitations" optionLabel="nom" [filter]="true" filterBy="nom"
              [showClear]="true" [(ngModel)]="selectedExploitation" placeholder="Eexploitation" appendTo="body"
              name="exploitations" [ngClass]="{'desactiver': selectedOperationSYN}">
              <ng-template let-exploitation pTemplate="item">
                <div class="country-item">
                  <div>{{ exploitation.nom }}</div>
                </div>
              </ng-template>
            </p-dropdown>
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-group">
            <label><b>N°Transaction</b> </label>
            <input type="text" pInputText [(ngModel)]="selectedTransaction" />
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label><b>Intervenant</b> </label>
            <p-dropdown [options]="listIntervenants" optionLabel="nom" [filter]="true" filterBy="nom" [showClear]="true"
              [(ngModel)]="selectedIntervenant" placeholder="Intervenant">
              <ng-template let-data pTemplate="item">
                <div class="country-item">
                  <div>{{ data.nom }}</div>
                </div>
              </ng-template>
            </p-dropdown>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label><b>Code Rapport</b> </label>
            <p-dropdown [options]="listCodeRapports" optionLabel="libele" [filter]="true" filterBy="libele"
              [showClear]="true" [(ngModel)]="selectedRapport" placeholder="Code rapport" name="libele">
              <ng-template let-data pTemplate="item">
                <div class="country-item">
                  <div>{{ data.libele }}</div>
                </div>
              </ng-template>
            </p-dropdown>
          </div>
        </div>
        <div class="p-0" [ngStyle]="{width: '4rem'}" *ngIf="!secondFilter">
          <label [ngStyle]="{'opacity':'0'}">Actions</label> <br>
          <p-button styleClass="p-button-success" icon="pi pi-filter" (click)="onFilter()"
            [disabled]="isFilter()"></p-button>
        </div>
        <div class="p-0" [ngStyle]="{width: '4rem'}">
          <label [ngStyle]="{'opacity':'0'}">Actions</label> <br>
          <p-button *ngIf="!secondFilter" (click)="showSecondFilter()" styleClass="p-button-dark"
            icon="pi pi-plus"></p-button>
          <p-button *ngIf="secondFilter" (click)="showSecondFilter()" styleClass="p-button-dark"
            icon="pi pi-minus"></p-button>
        </div>
      </div>
      <!--------------------Second-------------Filter--------->
      <div class="row filter_wrapper" style="padding-top: 0.7rem;" *ngIf="secondFilter">
        <div class="col-md-2">
          <div class="form-group">
            <label><b>Traitement</b> </label>
            <p-dropdown [options]="listTraitements" optionLabel="libele" [filter]="true" filterBy="libele"
              [showClear]="true" [(ngModel)]="selectedTraitement" placeholder="Statut" name="libele">
              <ng-template let-data pTemplate="item">
                <div class="country-item">
                  <div>{{ data.libele }}</div>
                </div>
              </ng-template>
            </p-dropdown>
          </div>
        </div>
        <div class="col-md-2">
          <label class="block"><b>Date début <span class="text-danger">*</span></b></label>
          <p-calendar [showIcon]="true" dateFormat="dd-mm-yy"></p-calendar>
        </div>
        <div class="col-md-2">
          <label class="block"><b>Date fin <span class="text-danger">*</span></b></label>
          <p-calendar [showIcon]="true" dateFormat="dd-mm-yy"></p-calendar>
        </div>
        <div class="p-0" [ngStyle]="{width: '4rem'}">
          <label [ngStyle]="{'opacity':'0'}">Actions</label> <br>
          <p-button styleClass="p-button-success" icon="pi pi-filter" (click)="onFilter()"
            [disabled]="isFilter()"></p-button>
        </div>
      </div>
      <p-table #dt [value]="listPriseEncharges" [rows]="10" [paginator]="true" [globalFilterFields]="[
                'id',
                'date',
                'num_transaction',
                'dr',
                'exploitation',
                'operation',
                'code_erreur',
                'message',
                'affectation',
                'intervenant',
            ]" responsiveLayout="scroll" [rowHover]="true" dataKey="id"
        currentPageReportTemplate="Affichage de {first} à {last} des {totalRecords} données"
        [showCurrentPageReport]="true">
        <ng-template pTemplate="caption">
          <div class="seach_and_btns p-0">
            <div>
              <button pButton pRipple label="Rafraichir" icon="pi pi-refresh" class="p-button-secondary"></button>
              <button pButton pRipple label="Exporter" icon="pi pi-download" class="p-button-helf ms-3"></button>
            </div>
            <div>
              <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input pInputText type="text" (input)="dt.filterGlobal($event.target.value,'contains')"
                  placeholder="Recherche..." />
              </span>
            </div>
          </div>
        </ng-template>
        <br />
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="id">#</th>
            <th pSortableColumn="date">Date</th>
            <th pSortableColumn="num_transaction">N°Transaction</th>
            <th pSortableColumn="dr">DR</th>
            <th [ngStyle]="{ width: '200px' }" pSortableColumn="exploitation">Exploitation</th>
            <th pSortableColumn="operation">Opération</th>
            <th pSortableColumn="code_erreur">Code Rapport</th>
            <th pSortableColumn="message">Message</th>
            <th pSortableColumn="affectation">Affectation</th>
            <th pSortableColumn="intervenant">Intervenant</th>
            <th>Action</th>
          </tr>
        </ng-template>
        <ng-template let-i="rowIndex" pTemplate="body" let-prise>
          <tr>
            <td style="text-align: center">{{i+1}}</td>
            <td style="text-align: center">{{ prise.updated_at}}</td>
            <td (click)="copyTransaction(prise.transaction)" style="text-align: center; cursor: pointer">
              {{prise.transaction}}</td>
            <td style="text-align: center">{{ prise.direction_regionale_code}}</td>
            <td (click)="copyTransaction(prise.exploitation_nom)" style="text-align: center">
              <div style="cursor: pointer">
                {{ prise.exploitation_nom }}
              </div>
            </td>
            <td style="text-align: center; cursor: pointer" (click)="copyTransaction(prise.operation)">
              {{prise.operation}}
            </td>
            <td style="text-align: center; cursor: pointer">
              <span [ngClass]="['badge', 'badge-'+prise.code_rapport.split('-')[1]]">{{ prise.code_rapport }}</span>
            </td>
            <td style="text-align: center">
              <button pButton pRipple type="button" icon="pi pi-eye" label="Voir" class="p-button-secondary"></button>
            </td>
            <td style="text-align: center">
              <span class="badge danger" *ngIf="prise.affectation === 'auto-affecté'">{{prise.affectation}}</span>
              <span class="badge" *ngIf="prise.affectation === 'affecté'">{{prise.affectation}}</span>
            </td>
            <td style="text-align: center">
              <span>
                {{ prise.intervenant_nom }} {{prise.intervenant_prenoms}}
              </span>
            </td>
            <td style="text-align: center">
              <button pButton pRipple type="button" icon="pi pi-arrow-right" label="Affecter"></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>