<main class="container-fluid form-slide-container" role="main">
    <p-toast position="top-right"></p-toast>
    
    <section class="row form-slide-row">
        <article class="col-sm-12 form-slide-article">
            <app-breadcrumb
                class="team-form-breadcrumb"
                [title]="module | translate"
                [active_item]="subModule | translate"
            ></app-breadcrumb>

            <section class="card form-slide-card">
                <div class="card-body form-slide-card-body">
                    <header class="actions-form-header">
                        <div class="d-flex align-items-center">
                            <app-page-title
                                class="page-title-component"
                                [displayDate]="false"
                                [displayList]="false"
                                [title]="
                                    isEditMode ? ('CONTENT_MANAGEMENT.SLIDE.FORM.TITLE_FORM_EDIT' | translate) : ('CONTENT_MANAGEMENT.SLIDE.FORM.TITLE_FORM_ADD' | translate)
                                "
                            >
                            </app-page-title>
                        </div>
                        <p-button
                            [label]="'COMMON.CLOSE' | translate"
                            (onClick)="onCancel()"
                            styleClass="p-button-danger"
                        >
                        </p-button>
                    </header>

                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm border-0">
                                <div class="card-body">
                                    <form class="form row g-3" [formGroup]="form" (ngSubmit)="onSubmit()">
                                        
                                        <fieldset class="fieldset">
                                            <legend>
                                                <b>{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.GENERAL_INFO' | translate }}</b>
                                            </legend>
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="title" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.TITLE' | translate }} <span class="text-danger">*</span></label>
                                                    <input class="form-input" id="title" formControlName="title" [placeholder]="'CONTENT_MANAGEMENT.SLIDE.FORM.TITLE_PLACEHOLDER' | translate" />
                                                    @if (form.get('title')?.invalid && form.get('title')?.touched) {
                                                        <small class="text-danger d-block mt-1">{{ 'VALIDATION.REQUIRED' | translate }}</small>
                                                    }
                                                </div>

                                                <div class="col-md-6">
                                                    <label for="subtitle" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.RESUME' | translate }} <span class="text-danger">*</span></label>
                                                    <input class="form-input" id="subtitle" formControlName="subtitle" />
                                                    @if (form.get('subtitle')?.invalid && form.get('subtitle')?.touched) {
                                                        <small class="text-danger d-block mt-1">{{ 'VALIDATION.REQUIRED' | translate }}</small>
                                                    }
                                                </div>

                                                <div class="col-12">
                                                    <label for="content" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.DESCRIPTION' | translate }}</label>
                                                    <p-editor formControlName="content" [style]="{ height: '100px' }"></p-editor>
                                                    @if (form.get('content')?.invalid && form.get('content')?.touched) {
                                                        <small class="text-danger d-block mt-1">{{ 'VALIDATION.REQUIRED' | translate }}</small>
                                                    }
                                                </div>
                                            </div>
                                        </fieldset>

                                        <fieldset class="fieldset">
                                            <legend>
                                                <b>{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.MEDIA_DISPLAY' | translate }}</b>
                                            </legend>
                                            <div class="row g-3 align-items-center">
                                                <div class="col-md-2">
                                                    <label for="timeDurationInSeconds" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.DURATION' | translate }}</label>
                                                    <input class="form-input" id="timeDurationInSeconds" type="number" min="1" max="10" formControlName="timeDurationInSeconds" />
                                                    @if (form.get('timeDurationInSeconds')?.invalid && form.get('timeDurationInSeconds')?.touched) {
                                                        <small class="text-danger d-block mt-1">{{ 'VALIDATION.REQUIRED' | translate }}</small>
                                                    }
                                                </div>

                                                <div class="col-md-2">
                                                    <label for="type" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.TYPE' | translate }} <span class="text-danger">*</span></label>
                                                    <p-select class="form-p-select" [options]="typeOptions" formControlName="type" optionLabel="label" optionValue="value" styleClass="w-100"></p-select>
                                                </div>

                                                <div class="col-md-8">
                                                    @if (isVideoType) {
                                                        <div class="fade-in">
                                                            <label class="form-label fw-bold d-block">
                                                                {{ 'CONTENT_MANAGEMENT.SLIDE.FORM.VIDEO' | translate }}
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            
                                                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                                                <p-fileUpload 
                                                                    mode="basic" 
                                                                    name="videoUpload" 
                                                                    accept="video/*" 
                                                                    [maxFileSize]="50000000" 
                                                                    (onSelect)="onVideoSelect($event)" 
                                                                    [chooseLabel]="'CONTENT_MANAGEMENT.SLIDE.FORM.CHOOSE_VIDEO' | translate" 
                                                                    styleClass="p-button-outlined">
                                                                </p-fileUpload>
                                                                
                                                                @if (videoPreview && !videoRemoved) {
                                                                    <div class="media-preview-container">
                                                                        <div class="d-flex align-items-center gap-2">
                                                                            <button 
                                                                                pButton 
                                                                                type="button" 
                                                                                icon="pi pi-eye" 
                                                                                [label]="'COMMON.PREVIEW' | translate" 
                                                                                class="p-button-rounded p-button-info p-button-text" 
                                                                                (click)="openPreview('video')">
                                                                            </button>
                                                                            
                                                                            <!-- <button 
                                                                                pButton 
                                                                                type="button" 
                                                                                icon="pi pi-trash" 
                                                                                [label]="'COMMON.DELETE' | translate" 
                                                                                class="p-button-rounded p-button-danger p-button-text" 
                                                                                (click)="removeVideo()">
                                                                            </button> -->
                                                                            
                                                                            <span class="text-success small">
                                                                                <i class="pi pi-check-circle me-1"></i>
                                                                                {{ uploadedVideoFile ? 
                                                                                    ('CONTENT_MANAGEMENT.SLIDE.MESSAGES.NEW_VIDEO_SELECTED' | translate) : 
                                                                                    ('CONTENT_MANAGEMENT.SLIDE.MESSAGES.EXISTING_VIDEO' | translate) 
                                                                                }}
                                                                            </span>
                                                                        </div>
                                                                        
                                                                        @if (videoPreview && typeof videoPreview === 'string') {
                                                                            <div class="position-relative ms-2">
                                                                                <div class="bg-dark rounded p-1">
                                                                                    <i class="pi pi-video text-white" style="font-size: 1.5rem;"></i>
                                                                                </div>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                }
                                                                
                                                                @if (videoRemoved && originalVideoUrl) {
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <button 
                                                                            pButton 
                                                                            type="button" 
                                                                            icon="pi pi-undo" 
                                                                            [label]="'COMMON.RESTORE' | translate" 
                                                                            class="p-button-rounded p-button-warning p-button-text" 
                                                                            (click)="restoreVideo()">
                                                                        </button>
                                                                    </div>
                                                                }
                                                                
                                                            </div>
                                                            <small class="text-danger d-block mt-1 validation-hint">
                                                                {{ 'CONTENT_MANAGEMENT.SLIDE.FORM.VALIDATION.VIDEO_REQUIRED' | translate }}
                                                            </small>
                                                        </div>
                                                    } @else {
                                                        <div class="fade-in">
                                                            <label class="form-label fw-bold d-block">
                                                                {{ 'CONTENT_MANAGEMENT.SLIDE.FORM.IMAGE' | translate }}
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            
                                                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                                                <p-fileUpload 
                                                                    mode="basic" 
                                                                    name="imageUpload" 
                                                                    accept="image/*" 
                                                                    [maxFileSize]="2000000" 
                                                                    (onSelect)="onFileSelect($event)" 
                                                                    [chooseLabel]="'CONTENT_MANAGEMENT.SLIDE.FORM.CHOOSE_IMAGE' | translate" 
                                                                    styleClass="p-button-outlined">
                                                                </p-fileUpload>
                                                                
                                                                @if (imagePreview && !imageRemoved) {
                                                                    <div class="media-preview-container">
                                                                        <div class="d-flex align-items-center gap-2">
                                                                            <button 
                                                                                pButton 
                                                                                type="button" 
                                                                                icon="pi pi-eye" 
                                                                                [label]="'COMMON.PREVIEW' | translate" 
                                                                                class="p-button-rounded p-button-info p-button-text" 
                                                                                (click)="openPreview('image')">
                                                                            </button>
                                                                            
                                                                            <!-- <button 
                                                                                pButton 
                                                                                type="button" 
                                                                                icon="pi pi-trash" 
                                                                                [label]="'COMMON.DELETE' | translate" 
                                                                                class="p-button-rounded p-button-danger p-button-text" 
                                                                                (click)="removeImage()">
                                                                            </button> -->
                                                                            
                                                                            <div class="position-relative">
                                                                                <img 
                                                                                    [src]="imagePreview" 
                                                                                    alt="Mini Preview" 
                                                                                    class="img-thumbnail rounded-circle shadow-sm media-thumbnail" 
                                                                                />
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                }
                                                                
                                                                @if (imageRemoved && originalImageUrl) {
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <button 
                                                                            pButton 
                                                                            type="button" 
                                                                            icon="pi pi-undo" 
                                                                            [label]="'COMMON.RESTORE' | translate" 
                                                                            class="p-button-rounded p-button-warning p-button-text" 
                                                                            (click)="restoreImage()">
                                                                        </button>
                                                                    </div>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </fieldset>

                                        <fieldset class="fieldset">
                                            <legend>
                                                <b>{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.CONFIG' | translate }}</b>
                                            </legend>
                                                
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="buttonLabel" class="form-label">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.BUTTON_LABEL' | translate }} <span class="text-danger">*</span></label>
                                                    <input class="form-input" id="buttonLabel" formControlName="buttonLabel" />
                                                    @if (form.get('buttonLabel')?.invalid && form.get('buttonLabel')?.touched) {
                                                        <small class="text-danger d-block mt-1">{{ 'VALIDATION.REQUIRED' | translate }}</small>
                                                    }
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="buttonUrl" class="form-label">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.BUTTON_URL' | translate }} <span class="text-danger">*</span></label>
                                                    <input class="form-input" id="buttonUrl" formControlName="buttonUrl" />
                                                    @if (form.get('buttonUrl')?.invalid && form.get('buttonUrl')?.touched) {
                                                        <small class="text-danger d-block mt-1">{{ 'VALIDATION.REQUIRED' | translate }}</small>
                                                    }
                                                </div>
                                            </div>

                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <label for="platforms" class="form-label">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.PLATFORMS' | translate }} <span class="text-danger">*</span></label>
                                                    <p-multiSelect 
                                                        class="form-p-select" 
                                                        [options]="platformOptions" 
                                                        formControlName="platforms" 
                                                        styleClass="w-100"
                                                        [filter]="false" 
                                                        [showToggleAll]="false">
                                                    </p-multiSelect>
                                                    @if (form.get('platforms')?.invalid && form.get('platforms')?.touched) {
                                                        <small class="text-danger d-block mt-1">{{ 'VALIDATION.REQUIRED' | translate }}</small>
                                                    }
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="startDate">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.START_DATE' | translate }}</label>
                                                    <p-datePicker 
                                                        class="form-p-datepicker" 
                                                        formControlName="startDate" 
                                                        [showTime]="true" 
                                                        [showIcon]="true" 
                                                        [placeholder]="'JJ-MM-AAAA'" 
                                                        dateFormat="dd-mm-yy">
                                                    </p-datePicker>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="endDate">{{ 'CONTENT_MANAGEMENT.SLIDE.FORM.END_DATE' | translate }}</label>
                                                    <p-datePicker 
                                                        class="form-p-datepicker" 
                                                        formControlName="endDate" 
                                                        [showTime]="true" 
                                                        [showIcon]="true" 
                                                        [placeholder]="'JJ-MM-AAAA'" 
                                                        dateFormat="dd-mm-yy">
                                                    </p-datePicker>
                                                </div>
                                            </div>
                                        </fieldset>

                                        <div class="d-flex justify-content-end gap-3 pt-3 pb-3 border-top">
                                            <p-button 
                                                label="{{ 'COMMON.CANCEL' | translate }}" 
                                                styleClass="p-button-text p-button-secondary" 
                                                (click)="onCancel()">
                                            </p-button>
                                            
                                            <p-button 
                                                label="{{ 'COMMON.SAVE' | translate }}" 
                                                (click)="onSubmit()" 
                                                [disabled]="saveButtonState.disabled"
                                                [styleClass]="saveButtonState.disabled ? 'p-button-disabled form-submit-button' : 'form-submit-button'">

                                            </p-button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </article>
    </section>
</main>

<p-dialog 
    [(visible)]="isPreviewVisible" 
    [modal]="true" 
    [style]="{width: '50vw', maxWidth: '800px'}" 
    [header]="(previewType === 'image' ? 'CONTENT_MANAGEMENT.SLIDE.FORM.IMAGE_PREVIEW' : 'CONTENT_MANAGEMENT.SLIDE.FORM.VIDEO_PREVIEW') | translate" 
    [dismissableMask]="true" 
    [draggable]="false" 
    [resizable]="false">
    
    <div class="d-flex justify-content-center align-items-center bg-light p-3 rounded">
        @if (previewType === 'image' && previewContent) {
            <img 
                [src]="previewContent" 
                alt="Full Preview" 
                class="img-fluid rounded shadow" 
                style="max-height: 70vh; object-fit: contain;" 
            />
        }
        @if (previewType === 'video' && previewContent) {
            <video 
                [src]="previewContent" 
                controls 
                autoplay 
                class="img-fluid rounded shadow" 
                style="max-height: 70vh;"
            ></video>
        }
        @if (!previewContent) {
            <p class="text-muted">
                <i class="pi pi-exclamation-circle me-2"></i>
                {{ 'CONTENT_MANAGEMENT.SLIDE.MESSAGES.NO_PREVIEW_CONTENT' | translate }}
            </p>
        }
    </div>
</p-dialog>