@if (isLoading$ | async) {
} @else {
<main class="container-fluid form-news-container" role="main">
    <section class="row form-news-row">
        <article class="col-sm-12 form-news-article">
            <app-breadcrumb
                class="team-form-breadcrumb"
                [title]="module() | translate"
                [active_item]="subModule() | translate"
            ></app-breadcrumb>

            <section class="card form-news-card">
                <div class="card-body form-news-card-body">
                    <header class="actions-form-header">
                        <div class="d-flex align-items-center">
                            <app-page-title
                                class="page-title-component"
                                [displayDate]="false"
                                [displayList]="false"
                                [title]="
                                    isEditMode() ? ('CONTENT_MANAGEMENT.NEWS.FORM.TITLE_FORM_EDIT' | translate) : ('CONTENT_MANAGEMENT.NEWS.FORM.TITLE_FORM_ADD' | translate)
                                "
                            >
                            </app-page-title>
                        </div>
                        <p-button
                            [label]="'COMMON.CLOSE' | translate"
                            (onClick)="onCancel()"
                            styleClass="p-button-danger"
                        >
                        </p-button>
                    </header>

                    <div class="row">
                            <div class="col-12">
                                <div class="card shadow-sm border-0">
                                    <div class="card-body p-4">
                                    
                                        <form class="form row g-3" [formGroup]="form" (ngSubmit)="onSubmit()">
                                            

                                            <fieldset class="fieldset">
                                                <legend>
                                                    <b>{{ 'CONTENT_MANAGEMENT.NEWS.FORM.MEDIA_DISPLAY' | translate }}</b>
                                                </legend>
                                                <div class="row g-3 align-items-center">

                                                    <div class="col-md-2 mt-0">
                                                        <label for="type" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.NEWS.FORM.TYPE' | translate }} <span class="text-danger">*</span></label>
                                                        <p-select class="form-p-select" [options]="typeOptions" formControlName="type" optionLabel="label" optionValue="value" styleClass="w-100"></p-select>
                                                    </div>

                                                   <div class="col-md-10">
                                                    @if (form.get('type')?.value === TypeMediaDto.VIDEO) {
                                                        <div class="video-url-section">
                                                            <label for="videoUrl" class="form-label fw-bold">
                                                                {{ 'CONTENT_MANAGEMENT.NEWS.FORM.VIDEO_URL' | translate }} 
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            
                                                            <input class="form-input" 
                                                                id="videoUrl" 
                                                                formControlName="videoUrl"
                                                                [placeholder]="'https://youtube.com/watch?v=... ou https://vimeo.com/...'"
                                                                [attr.maxlength]="VALIDATION.VIDEO_URL.MAX"
                                                                [attr.aria-label]="'URL de la vidéo, formats supportés: YouTube, Vimeo, Dailymotion'" />
                                                            
                                                            <div class="d-flex justify-content-between align-items-center mt-1">
                                                                @if (form.get('videoUrl')?.invalid && form.get('videoUrl')?.touched) {
                                                                    <small class="text-danger">
                                                                        {{ getErrorMessage('videoUrl') }}
                                                                    </small>
                                                                }
                                                                
                                                                <small class="text-muted ms-auto">
                                                                    {{ (form.get('videoUrl')?.value || '').length }}/{{ VALIDATION.VIDEO_URL.MAX }}
                                                                </small>
                                                            </div>
                                                            
                                                            @if (form.get('videoUrl')?.value && form.get('videoUrl')?.valid) {
                                                                <div class="video-platform-indicator mt-2">
                                                                    @let videoUrl = form.get('videoUrl')?.value;
                                                                    @let platform = detectVideoPlatform(videoUrl);
                                                                    
                                                                    <div class="d-flex align-items-center gap-2">
                                                                        <i [class]="getVideoPlatformIcon(platform)"></i>
                                                                        <small class="text-success">
                                                                            {{ getVideoPlatformName(platform) }}
                                                                        </small>
                                                                        <small class="text-muted ms-2">
                                                                            <i class="pi pi-check-circle text-success"></i>
                                                                            {{ 'CONTENT_MANAGEMENT.NEWS.FORM.VIDEO_PLATFORM_SUPPORTED' | translate }}
                                                                        </small>
                                                                    </div>
                                                                </div>
                                                            }
                                                            
                                                            <small class="text-muted d-block mt-2">
                                                                <i class="pi pi-info-circle me-1"></i>
                                                                {{ 'CONTENT_MANAGEMENT.NEWS.FORM.VIDEO_URL_HELP' | translate }}
                                                            </small>
                                                        </div>
                                                    } @else {
                                                        <div class="image-section">
                                                            <label class="form-label fw-bold d-block mb-2">
                                                                {{ 'CONTENT_MANAGEMENT.NEWS.FORM.IMAGE' | translate }}
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            
                                                            <div class="image-upload-area d-flex gap-2">
                                                                <div class="d-flex align-items-center gap-3 flex-wrap">
                                                                    <p-fileUpload 
                                                                        mode="basic" 
                                                                        name="imageUpload" 
                                                                        accept="image/*" 
                                                                        [maxFileSize]="VALIDATION.IMAGE_FILE.MAX_SIZE_MB * 1000000" 
                                                                        (onSelect)="onFileSelect($event)" 
                                                                        [chooseLabel]="'CONTENT_MANAGEMENT.NEWS.FORM.CHOOSE_IMAGE' | translate" 
                                                                        styleClass="p-button-outlined">
                                                                    </p-fileUpload>
                                                                </div>
                                                                
                                                                @if (imagePreview() && !imageRemoved()) {
                                                                    <div class="media-preview-container">
                                                                        <div class="d-flex align-items-center gap-3">
                                                                            <button 
                                                                                pButton 
                                                                                type="button" 
                                                                                icon="pi pi-eye" 
                                                                                [label]="'COMMON.PREVIEW' | translate" 
                                                                                class="p-button-rounded p-button-info p-button-text" 
                                                                                (click)="openPreview('image')">
                                                                            </button>
                                                                            
                                                                            <div class="position-relative">
                                                                                <img 
                                                                                    [src]="imagePreview()" 
                                                                                    alt="Mini Preview" 
                                                                                    class="img-thumbnail rounded shadow-sm media-thumbnail" 
                                                                                />
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            </div>
                                                            
                                                            <div class="image-help">
                                                                <small class="text-muted d-block">
                                                                    <i class="pi pi-info-circle me-1"></i>
                                                                    <!-- {{ 'CONTENT_MANAGEMENT.NEWS.FORM.VALIDATION.IMAGE_HELP' | translate:{ 
                                                                        maxSize: VALIDATION.IMAGE_FILE.MAX_SIZE_MB,
                                                                        maxWidth: VALIDATION.IMAGE_FILE.MAX_DIMENSIONS.WIDTH,
                                                                        maxHeight: VALIDATION.IMAGE_FILE.MAX_DIMENSIONS.HEIGHT
                                                                    } }} -->
                                                                       <strong>{{ 'CONTENT_MANAGEMENT.NEWS.FORM.VALIDATION.SUPPORTED_FORMATS' | translate }}:</strong>
                                                                        {{ allowedImageTypes }}
                                                                </small>
                                                                
                                                                <!-- <div class="supported-formats mt-1">
                                                                    <small class="text-muted">
                                                                        <strong>{{ 'CONTENT_MANAGEMENT.NEWS.FORM.VALIDATION.SUPPORTED_FORMATS' | translate }}:</strong>
                                                                        {{ allowedImageTypes }}
                                                                    </small>
                                                                </div> -->
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                                </div>
                                            </fieldset>

                                            <fieldset class="fieldset">
                                                <legend>
                                                    <b>{{ 'CONTENT_MANAGEMENT.NEWS.FORM.CONFIG' | translate }}</b>
                                                </legend>
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <label for="categoryId" class="form-label fw-bold">
                                                            {{ 'CONTENT_MANAGEMENT.NEWS.FORM.CATEGORY' | translate }} 
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        <p-select 
                                                            class="form-p-select"
                                                            [options]="categoriesOptions$ | async" 
                                                            formControlName="categoryId" 
                                                            optionLabel="name" 
                                                            optionValue="id" 
                                                            styleClass="w-100" 
                                                            [placeholder]="'CONTENT_MANAGEMENT.NEWS.FORM.CATEGORY_PLACEHOLDER' | translate">
                                                        </p-select>
                                                        @if (form.get('categoryId')?.invalid && form.get('categoryId')?.touched) {
                                                            <small class="text-danger d-block mt-1">{{ 'VALIDATION.REQUIRED' | translate }}</small>
                                                        }
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label for="subCategoryId" class="form-label fw-bold">
                                                            {{ 'CONTENT_MANAGEMENT.NEWS.FORM.SUB_CATEGORY' | translate }}
                                                        </label>
                                                        <p-select 
                                                            class="form-p-select"
                                                            [options]="subCategoriesOptions$ | async" 
                                                            formControlName="subCategoryId" 
                                                            optionLabel="name" 
                                                            optionValue="id" 
                                                            styleClass="w-100" 
                                                            [placeholder]="'CONTENT_MANAGEMENT.NEWS.FORM.SUB_CATEGORY_PLACEHOLDER' | translate">
                                                        </p-select>
                                                        @if (!form.get('categoryId')?.value) {
                                                            <small class="text-muted d-block mt-1">
                                                                <i class="pi pi-info-circle me-1"></i>
                                                                {{ 'CONTENT_MANAGEMENT.NEWS.FORM.SELECT_CATEGORY_FIRST' | translate }}
                                                            </small>
                                                        } @else if ((subCategoriesOptions$ | async)?.length === 0) {
                                                            <small class="text-muted d-block mt-1">
                                                                <i class="pi pi-info-circle me-1"></i>
                                                                {{ 'CONTENT_MANAGEMENT.NEWS.FORM.NO_SUB_CATEGORIES' | translate }}
                                                            </small>
                                                        }
                                                    </div>

                                                    <div class="col-md-5">
                                                        <label for="hashtags" class="form-label fw-bold">
                                                            {{ 'CONTENT_MANAGEMENT.NEWS.FORM.HASHTAGS' | translate }} 
                                                        </label>
                                                        <app-hashtags-input
                                                            [label]="'CONTENT_MANAGEMENT.NEWS.FORM.HASHTAGS' | translate"
                                                            [required]="true"
                                                            [minHashtags]="1"
                                                            [maxHashtags]="10"
                                                            [showStats]="true"
                                                            (hashtagsChanged)="onHashtagsChanged($event)"
                                                            (hashtagAdded)="onHashtagAdded($event)"
                                                            (hashtagRemoved)="onHashtagRemoved($event)"
                                                            (hashtagsCleared)="onHashtagsCleared()"
                                                        ></app-hashtags-input>
                                                        @if (hashtagsArray.invalid && hashtagsArray.touched) {
                                                            <small class="text-danger d-block mt-1">
                                                                @if (hashtagsArray.errors?.['required']) {
                                                                    {{ 'VALIDATION.AT_LEAST_ONE_HASHTAG' | translate }}
                                                                }
                                                                @if (hashtagsArray.errors?.['maxHashtags']) {
                                                                    {{ 'VALIDATION.MAX_HASHTAGS_EXCEEDED' | translate:{ max: hashtagsArray.errors['maxHashtags'].max } }}
                                                                }
                                                                @if (hashtagsArray.errors?.['duplicateHashtags']) {
                                                                    {{ 'VALIDATION.DUPLICATE_HASHTAGS' | translate }}
                                                                }
                                                            </small>
                                                        }
                                                    </div>
                                                </div>
                                            </fieldset>

                                            <fieldset class="fieldset">
                                            <legend>
                                                <b>{{ 'CONTENT_MANAGEMENT.NEWS.FORM.GENERAL_INFO' | translate }}</b>
                                            </legend>
                                            <div class="row g-3">
                                                <div class="col-md-12">
                                                    <label for="title" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.NEWS.FORM.TITLE' | translate }} <span class="text-danger">*</span></label>
                                                    <input class="form-input" id="title" formControlName="title" 
                                                        [placeholder]="'CONTENT_MANAGEMENT.NEWS.FORM.TITLE_PLACEHOLDER' | translate"
                                                        [attr.maxlength]="VALIDATION.TITLE.MAX" />
                                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                                        @if (form.get('title')?.invalid && form.get('title')?.touched) {
                                                            <small class="text-danger">
                                                                {{ getErrorMessage('title') }}
                                                            </small>
                                                        }
                                                        <small class="text-muted ms-auto">
                                                            {{ (form.get('title')?.value || '').length }}/{{ VALIDATION.TITLE.MAX }}
                                                        </small>
                                                    </div>
                                                </div>

                                                <div class="col-md-12">
                                                    <label for="resume" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.NEWS.FORM.RESUME' | translate }} <span class="text-danger">*</span></label>
                                                    <textarea rows="3" cols="30" pTextarea id="resume" formControlName="resume" 
                                                        class="w-100"
                                                        [attr.maxlength]="VALIDATION.RESUME.MAX"></textarea>
                                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                                        @if (form.get('resume')?.invalid && form.get('resume')?.touched) {
                                                            <small class="text-danger">
                                                                {{ getErrorMessage('resume') }}
                                                            </small>
                                                        }
                                                        <small class="text-muted ms-auto">
                                                            {{ (form.get('resume')?.value || '').length }}/{{ VALIDATION.RESUME.MAX }}
                                                        </small>
                                                    </div>
                                                </div>

                                                <div class="col-12">
                                                    <label for="content" class="form-label fw-bold">{{ 'CONTENT_MANAGEMENT.NEWS.FORM.DESCRIPTION' | translate }} <span class="text-danger">*</span></label>
                                                    <p-editor formControlName="content" [style]="{ height: '200px' }"></p-editor>
                                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                                        @if (form.get('content')?.invalid && form.get('content')?.touched) {
                                                            <small class="text-danger">
                                                                {{ getErrorMessage('content') }}
                                                            </small>
                                                        }
                                                        <div class="d-flex align-items-center gap-2 ms-auto">
                                                            @let countStatus = getContentCountStatus();
                                                            @let charCount = getContentCharacterCount();
                                                            <small [class]="{
                                                                'text-success': countStatus === 'safe',
                                                                'text-warning': countStatus === 'warning',
                                                                'text-danger': countStatus === 'danger'
                                                            }">
                                                                {{ charCount }}/{{ VALIDATION.CONTENT.STRIP_HTML_MAX }}
                                                            </small>
                                                            @if (countStatus === 'warning') {
                                                                <i class="pi pi-exclamation-triangle text-warning"></i>
                                                            }
                                                            @if (countStatus === 'danger') {
                                                                <i class="pi pi-exclamation-circle text-danger"></i>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </fieldset>

                                            <div class="d-flex justify-content-end gap-3 pt-3 border-top">
                                                <p-button label="{{ 'COMMON.CANCEL' | translate }}" styleClass="p-button-text p-button-secondary" (click)="onCancel()"></p-button>
                                                 <p-button label="{{ 'COMMON.SAVE' | translate }}" (click)="onSubmit()">
                                            </p-button>
                                            </div>

                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </section>

        </article>
    </section>
</main>
}

<p-dialog 
    [(visible)]="isPreviewVisible" 
    [modal]="true" 
    [style]="{width: '50vw', maxWidth: '800px'}" 
    [header]="(previewType() === 'image' ? 'CONTENT_MANAGEMENT.NEWS.FORM.IMAGE_PREVIEW' : 'CONTENT_MANAGEMENT.NEWS.FORM.VIDEO_PREVIEW') | translate" 
    [dismissableMask]="true" 
    [draggable]="false" 
    [resizable]="false">
    
    <div class="d-flex justify-content-center align-items-center bg-light p-3 rounded">
        @if (previewType() === 'image' && previewContent()) {
            <img 
                [src]="previewContent()" 
                alt="Full Preview" 
                class="img-fluid rounded shadow" 
                style="max-height: 70vh; object-fit: contain;" 
            />
        }
        @if (previewType() === 'video' && previewContent()) {
            <video 
                [src]="previewContent()" 
                controls 
                autoplay 
                class="img-fluid rounded shadow" 
                style="max-height: 70vh;"
            ></video>
        }
        @if (!previewContent()) {
            <p class="text-muted">
                <i class="pi pi-exclamation-circle me-2"></i>
                {{ 'CONTENT_MANAGEMENT.NEWS.MESSAGES.NO_PREVIEW_CONTENT' | translate }}
            </p>
        }
    </div>
    
    <ng-template pTemplate="footer">
        <div class="d-flex justify-content-between w-100">
            <p-button 
                label="{{ 'COMMON.CLOSE' | translate }}" 
                (click)="isPreviewVisible = false" 
                styleClass="p-button-text">
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<!-- @if(selectedFileForCropping()) {
    <app-image-cropper 
    [(visible)]="showCropDialog"
    [imageSrc]="imageForCropping()"
    [originalFile]="selectedFileForCropping()"
    (cropComplete)="onCropComplete($event)"
    (error)="onCropError($event)"
    ></app-image-cropper>
} -->
